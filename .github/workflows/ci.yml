name: C++ CI

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'
      - 'vcpkg.json'
      - '.clang-tidy'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'
      - 'vcpkg.json'
      - '.clang-tidy'

env:
  VCPKG_ROOT: /opt/vcpkg
  VCPKG_BINCACHE: /tmp/vcpkg-bincache

jobs:
  build-test:
    name: Build & Test (GCC 14)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y g++-14 cmake ninja-build

      - name: Cache vcpkg binary packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ${{ env.VCPKG_BINCACHE }}
          key: vcpkg-linux-x64-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-linux-x64-

      - name: Install vcpkg
        run: |
          git clone --depth=1 --branch 2026.01.16 https://github.com/microsoft/vcpkg.git $VCPKG_ROOT
          # 공급망 공격 방지: 예상 커밋 SHA 검증
          actual_sha=$(git -C $VCPKG_ROOT rev-parse HEAD)
          expected_sha="66c0373dc7fca549e5803087b9487edfe3aca0a1"
          if [ "$actual_sha" != "$expected_sha" ]; then
            echo "❌ vcpkg SHA 불일치: expected $expected_sha, got $actual_sha"
            exit 1
          fi
          $VCPKG_ROOT/bootstrap-vcpkg.sh -disableMetrics
          mkdir -p $VCPKG_BINCACHE
          echo "VCPKG_BINARY_SOURCES=clear;files,$VCPKG_BINCACHE,readwrite" >> "$GITHUB_ENV"

      - name: Configure (Release)
        run: cmake --preset default

      - name: Build
        run: cmake --build build/default -j$(nproc)

      - name: Run tests
        run: ctest --test-dir build/default --output-on-failure -j$(nproc)

  static-analysis:
    name: Static Analysis (clang-tidy + cppcheck)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y g++-14 cmake ninja-build cppcheck \
            gnupg curl
          # LLVM 19 apt repository (clang-tidy 19: Standard c++23 지원)
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://apt.llvm.org/llvm-snapshot.gpg.key \
            | sudo gpg --dearmor -o /etc/apt/keyrings/llvm.gpg
          echo "deb [signed-by=/etc/apt/keyrings/llvm.gpg] https://apt.llvm.org/noble/ llvm-toolchain-noble-19 main" \
            | sudo tee /etc/apt/sources.list.d/llvm19.list
          sudo apt-get update -qq
          sudo apt-get install -y clang-tidy-19
          sudo update-alternatives --install /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-19 100

      - name: Cache vcpkg binary packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ${{ env.VCPKG_BINCACHE }}
          key: vcpkg-linux-x64-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-linux-x64-

      - name: Install vcpkg
        run: |
          git clone --depth=1 --branch 2026.01.16 https://github.com/microsoft/vcpkg.git $VCPKG_ROOT
          # 공급망 공격 방지: 예상 커밋 SHA 검증
          actual_sha=$(git -C $VCPKG_ROOT rev-parse HEAD)
          expected_sha="66c0373dc7fca549e5803087b9487edfe3aca0a1"
          if [ "$actual_sha" != "$expected_sha" ]; then
            echo "❌ vcpkg SHA 불일치: expected $expected_sha, got $actual_sha"
            exit 1
          fi
          $VCPKG_ROOT/bootstrap-vcpkg.sh -disableMetrics
          mkdir -p $VCPKG_BINCACHE
          echo "VCPKG_BINARY_SOURCES=clear;files,$VCPKG_BINCACHE,readwrite" >> "$GITHUB_ENV"

      - name: Configure (Debug + compile_commands.json)
        run: cmake --preset debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build (generate headers)
        run: cmake --build build/debug -j$(nproc)

      - name: Run clang-tidy
        run: |
          set -o pipefail
          # 파일 단위로 실행해 종료코드 수집을 안정화하고,
          # 단일 대형 프로세스에서 발생하는 리소스 스파이크를 줄인다.
          CLANG_TIDY_RESULT=0
          : > /tmp/clang-tidy-report.txt
          gcc_major="$(g++-14 -dumpfullversion -dumpversion | cut -d. -f1)"
          gcc_triple="$(g++-14 -dumpmachine)"
          clang_tidy_args=(
            -p build/debug
            --extra-arg=-std=c++23
            --extra-arg=--gcc-toolchain=/usr
          )
          if [ -d "/usr/include/c++/${gcc_major}" ]; then
            clang_tidy_args+=(--extra-arg=-isystem --extra-arg="/usr/include/c++/${gcc_major}")
          fi
          if [ -d "/usr/include/${gcc_triple}/c++/${gcc_major}" ]; then
            clang_tidy_args+=(--extra-arg=-isystem --extra-arg="/usr/include/${gcc_triple}/c++/${gcc_major}")
          fi
          while IFS= read -r -d '' file; do
            file_abs="$(realpath "${file}")"
            echo "==> clang-tidy ${file_abs}" | tee -a /tmp/clang-tidy-report.txt
            if ! clang-tidy "${clang_tidy_args[@]}" "${file_abs}" 2>&1 | tee -a /tmp/clang-tidy-report.txt; then
              CLANG_TIDY_RESULT=1
            fi
          done < <(find src/ -name '*.cpp' -print0 | sort -z)
          # error 수준 진단 또는 clang-tidy 실행 실패가 있으면 CI 실패
          if [ $CLANG_TIDY_RESULT -ne 0 ] || grep -qE "^.+:[0-9]+:[0-9]+: error:" /tmp/clang-tidy-report.txt; then
            echo "clang-tidy 오류가 발견되었습니다."
            exit 1
          fi

      - name: Run cppcheck
        run: |
          cppcheck \
            --enable=warning,performance,portability \
            --error-exitcode=1 \
            --std=c++23 \
            --project=build/debug/compile_commands.json \
            --suppress=missingInclude \
            --suppress=unmatchedSuppression \
            --suppress=missingIncludeSystem \
            -i build/ \
            2>&1

  asan:
    name: AddressSanitizer
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y g++-14 cmake ninja-build

      - name: Cache vcpkg binary packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ${{ env.VCPKG_BINCACHE }}
          key: vcpkg-linux-x64-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-linux-x64-

      - name: Install vcpkg
        run: |
          git clone --depth=1 --branch 2026.01.16 https://github.com/microsoft/vcpkg.git $VCPKG_ROOT
          # 공급망 공격 방지: 예상 커밋 SHA 검증
          actual_sha=$(git -C $VCPKG_ROOT rev-parse HEAD)
          expected_sha="66c0373dc7fca549e5803087b9487edfe3aca0a1"
          if [ "$actual_sha" != "$expected_sha" ]; then
            echo "❌ vcpkg SHA 불일치: expected $expected_sha, got $actual_sha"
            exit 1
          fi
          $VCPKG_ROOT/bootstrap-vcpkg.sh -disableMetrics
          mkdir -p $VCPKG_BINCACHE
          echo "VCPKG_BINARY_SOURCES=clear;files,$VCPKG_BINCACHE,readwrite" >> "$GITHUB_ENV"

      - name: Configure (ASan)
        run: cmake --preset asan

      - name: Build
        run: cmake --build build/asan -j$(nproc)

      - name: Run tests (ASan)
        run: ctest --test-dir build/asan --output-on-failure -j$(nproc)
        env:
          ASAN_OPTIONS: detect_leaks=1:abort_on_error=1:symbolize=1

  tsan:
    name: ThreadSanitizer
    # TSan은 GCC에서 aarch64 미지원 — ubuntu-24.04는 x86_64 고정
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y g++-14 cmake ninja-build

      - name: Cache vcpkg binary packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ${{ env.VCPKG_BINCACHE }}
          key: vcpkg-linux-x64-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-linux-x64-

      - name: Install vcpkg
        run: |
          git clone --depth=1 --branch 2026.01.16 https://github.com/microsoft/vcpkg.git $VCPKG_ROOT
          # 공급망 공격 방지: 예상 커밋 SHA 검증
          actual_sha=$(git -C $VCPKG_ROOT rev-parse HEAD)
          expected_sha="66c0373dc7fca549e5803087b9487edfe3aca0a1"
          if [ "$actual_sha" != "$expected_sha" ]; then
            echo "❌ vcpkg SHA 불일치: expected $expected_sha, got $actual_sha"
            exit 1
          fi
          $VCPKG_ROOT/bootstrap-vcpkg.sh -disableMetrics
          mkdir -p $VCPKG_BINCACHE
          echo "VCPKG_BINARY_SOURCES=clear;files,$VCPKG_BINCACHE,readwrite" >> "$GITHUB_ENV"

      - name: Configure (TSan)
        run: cmake --preset tsan

      - name: Build
        run: cmake --build build/tsan -j$(nproc)

      - name: Run tests (TSan)
        run: ctest --test-dir build/tsan --output-on-failure -j$(nproc)
        env:
          TSAN_OPTIONS: halt_on_error=1:symbolize=1
