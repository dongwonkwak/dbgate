name: C++ CI

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'
      - 'vcpkg.json'
      - '.clang-tidy'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'
      - 'vcpkg.json'
      - '.clang-tidy'

env:
  VCPKG_ROOT: /opt/vcpkg
  VCPKG_BINCACHE: /tmp/vcpkg-bincache

jobs:
  build-test:
    name: Build & Test (GCC 14)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y g++-14 cmake ninja-build

      - name: Cache vcpkg binary packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ${{ env.VCPKG_BINCACHE }}
          key: vcpkg-linux-x64-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-linux-x64-

      - name: Install vcpkg
        run: |
          git clone --depth=1 --branch 2026.01.16 https://github.com/microsoft/vcpkg.git $VCPKG_ROOT
          # 공급망 공격 방지: 예상 커밋 SHA 검증
          actual_sha=$(git -C $VCPKG_ROOT rev-parse HEAD)
          expected_sha="66c0373dc7fca549e5803087b9487edfe3aca0a1"
          if [ "$actual_sha" != "$expected_sha" ]; then
            echo "❌ vcpkg SHA 불일치: expected $expected_sha, got $actual_sha"
            exit 1
          fi
          $VCPKG_ROOT/bootstrap-vcpkg.sh -disableMetrics
          mkdir -p $VCPKG_BINCACHE
          echo "VCPKG_BINARY_SOURCES=clear;files,$VCPKG_BINCACHE,readwrite" >> "$GITHUB_ENV"

      - name: Configure (Release)
        run: cmake --preset default

      - name: Build
        run: cmake --build build/default -j$(nproc)

      - name: Run tests
        run: ctest --test-dir build/default --output-on-failure -j$(nproc)

  static-analysis:
    name: Static Analysis (clang-tidy + cppcheck)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y g++-14 cmake ninja-build clang-tidy cppcheck

      - name: Cache vcpkg binary packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ${{ env.VCPKG_BINCACHE }}
          key: vcpkg-linux-x64-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-linux-x64-

      - name: Install vcpkg
        run: |
          git clone --depth=1 --branch 2026.01.16 https://github.com/microsoft/vcpkg.git $VCPKG_ROOT
          # 공급망 공격 방지: 예상 커밋 SHA 검증
          actual_sha=$(git -C $VCPKG_ROOT rev-parse HEAD)
          expected_sha="66c0373dc7fca549e5803087b9487edfe3aca0a1"
          if [ "$actual_sha" != "$expected_sha" ]; then
            echo "❌ vcpkg SHA 불일치: expected $expected_sha, got $actual_sha"
            exit 1
          fi
          $VCPKG_ROOT/bootstrap-vcpkg.sh -disableMetrics
          mkdir -p $VCPKG_BINCACHE
          echo "VCPKG_BINARY_SOURCES=clear;files,$VCPKG_BINCACHE,readwrite" >> "$GITHUB_ENV"

      - name: Configure (Debug + compile_commands.json)
        run: cmake --preset debug -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build (generate headers)
        run: cmake --build build/debug -j$(nproc)

      - name: Run clang-tidy
        run: |
          set -o pipefail
          # xargs/clang-tidy 종료코드를 파이프라인 실패로 전파 (pipefail)
          # || 로 종료코드를 보존하여 tee 성공에 마스킹되지 않도록 명시적 검증
          CLANG_TIDY_RESULT=0
          find src/ -name '*.cpp' -print0 | \
            xargs -0 -P$(nproc) clang-tidy -p build/debug 2>&1 | \
            tee /tmp/clang-tidy-report.txt || CLANG_TIDY_RESULT=$?
          # error: 수준 문제 시 실패 (xargs 종료코드 + grep 이중 검증)
          if [ $CLANG_TIDY_RESULT -ne 0 ] || grep -qE "^.+:[0-9]+:[0-9]+: error:" /tmp/clang-tidy-report.txt; then
            echo "clang-tidy 오류가 발견되었습니다."
            exit 1
          fi

      - name: Run cppcheck
        run: |
          cppcheck \
            --enable=warning,performance,portability \
            --error-exitcode=1 \
            --std=c++23 \
            --project=build/debug/compile_commands.json \
            --suppress=missingInclude \
            --suppress=unmatchedSuppression \
            --suppress=missingIncludeSystem \
            -i build/ \
            2>&1

  asan:
    name: AddressSanitizer
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y g++-14 cmake ninja-build

      - name: Cache vcpkg binary packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ${{ env.VCPKG_BINCACHE }}
          key: vcpkg-linux-x64-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-linux-x64-

      - name: Install vcpkg
        run: |
          git clone --depth=1 --branch 2026.01.16 https://github.com/microsoft/vcpkg.git $VCPKG_ROOT
          # 공급망 공격 방지: 예상 커밋 SHA 검증
          actual_sha=$(git -C $VCPKG_ROOT rev-parse HEAD)
          expected_sha="66c0373dc7fca549e5803087b9487edfe3aca0a1"
          if [ "$actual_sha" != "$expected_sha" ]; then
            echo "❌ vcpkg SHA 불일치: expected $expected_sha, got $actual_sha"
            exit 1
          fi
          $VCPKG_ROOT/bootstrap-vcpkg.sh -disableMetrics
          mkdir -p $VCPKG_BINCACHE
          echo "VCPKG_BINARY_SOURCES=clear;files,$VCPKG_BINCACHE,readwrite" >> "$GITHUB_ENV"

      - name: Configure (ASan)
        run: cmake --preset asan

      - name: Build
        run: cmake --build build/asan -j$(nproc)

      - name: Run tests (ASan)
        run: ctest --test-dir build/asan --output-on-failure -j$(nproc)
        env:
          ASAN_OPTIONS: detect_leaks=1:abort_on_error=1:symbolize=1

  tsan:
    name: ThreadSanitizer
    # TSan은 GCC에서 aarch64 미지원 — ubuntu-24.04는 x86_64 고정
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y g++-14 cmake ninja-build

      - name: Cache vcpkg binary packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ${{ env.VCPKG_BINCACHE }}
          key: vcpkg-linux-x64-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-linux-x64-

      - name: Install vcpkg
        run: |
          git clone --depth=1 --branch 2026.01.16 https://github.com/microsoft/vcpkg.git $VCPKG_ROOT
          # 공급망 공격 방지: 예상 커밋 SHA 검증
          actual_sha=$(git -C $VCPKG_ROOT rev-parse HEAD)
          expected_sha="66c0373dc7fca549e5803087b9487edfe3aca0a1"
          if [ "$actual_sha" != "$expected_sha" ]; then
            echo "❌ vcpkg SHA 불일치: expected $expected_sha, got $actual_sha"
            exit 1
          fi
          $VCPKG_ROOT/bootstrap-vcpkg.sh -disableMetrics
          mkdir -p $VCPKG_BINCACHE
          echo "VCPKG_BINARY_SOURCES=clear;files,$VCPKG_BINCACHE,readwrite" >> "$GITHUB_ENV"

      - name: Configure (TSan)
        run: cmake --preset tsan

      - name: Build
        run: cmake --build build/tsan -j$(nproc)

      - name: Run tests (TSan)
        run: ctest --test-dir build/tsan --output-on-failure -j$(nproc)
        env:
          TSAN_OPTIONS: halt_on_error=1:symbolize=1
