# dbgate 데이터 흐름 문서

## 목적
- 클라이언트 요청이 `dbgate`를 거쳐 MySQL 서버로 전달되고 응답이 돌아오는 흐름을 설명한다.
- 정책 판정, 차단, 에러 처리, 관측성 포인트가 어디서 발생하는지 명확히 한다.

## 적용 범위
- 데이터패스(C++): `src/protocol/`, `src/proxy/`, `src/parser/`, `src/policy/`, `src/logger/`, `src/stats/`
- 컨트롤플레인(Go)은 본 문서에서 직접 다루지 않으며, UDS 연동은 `docs/uds-protocol.md` 참고

## 관련 문서
- `docs/architecture.md`
- `docs/interface-reference.md`
- `docs/uds-protocol.md`
- `docs/policy-engine.md` (작성 예정/존재 시)

## 공통 전제
- 핸드셰이크는 패스스루(프록시가 인증에 개입하지 않음)
- 정책 엔진 오류 시 `fail-close`
- SQL 파서는 경량 파서(키워드 + 정규식 기반)

## 흐름 분류
본 문서는 최소 아래 흐름을 유지한다.

1. 정상 쿼리 통과 흐름 (`ALLOW`)
2. 정책 차단 흐름 (`BLOCK`)
3. 파싱 실패 / 정책 오류 흐름 (`fail-close`)
4. 비-`COM_QUERY` 커맨드 패스스루 흐름
5. 세션 종료/에러 종료 흐름

## 데이터 흐름 템플릿 (시나리오별로 반복)

### 시나리오 이름
- 입력:
- 사전 조건:
- 주요 컴포넌트:
- 출력/결과:

#### 단계
1. 
2. 
3. 

#### 관측성 포인트
- 로그:
- 통계:
- 헬스체크 영향:

#### 문서화해야 하는 한계/주의점
- 

## 시나리오 1: 정상 쿼리 통과 흐름 (초안)

### 입력
- 클라이언트가 `COM_QUERY` 패킷으로 SQL 전송

### 사전 조건
- 세션 핸드셰이크 완료
- 정책 로드 성공 상태

### 주요 컴포넌트
- `proxy/session`
- `protocol/command`
- `parser/*`
- `policy/policy_engine`
- `logger`, `stats`

### 출력/결과
- 쿼리 릴레이 수행
- 서버 응답 전달
- 로그/통계 갱신

#### 단계
1. 세션이 클라이언트 패킷을 읽고 `COM_QUERY` 여부를 판별한다.
2. SQL 문자열을 추출하고 파서/탐지/정책 엔진에 전달한다.
3. 정책 판정이 `ALLOW`이면 업스트림 MySQL로 릴레이한다.
4. 응답을 클라이언트로 전달하고 로그/통계를 갱신한다.

#### 관측성 포인트
- 로그: 세션/쿼리/판정 결과
- 통계: 총 쿼리 수, 차단 수(해당 없음), 활성 세션

#### 문서화해야 하는 한계/주의점
- SQL 파싱 범위 밖 쿼리는 보수적으로 처리되는지 확인 필요

## 시나리오 2+: TODO
- `BLOCK` 흐름
- 파싱 실패 / 정책 오류 (`fail-close`)
- `COM_QUERY` 외 커맨드
- 세션 종료/타임아웃/EOF

## 변경 체크리스트 (문서 유지보수용)
- 데이터 흐름 단계가 실제 구현과 일치하는가?
- 파서/정책/로깅/통계 호출 순서가 바뀌었는가?
- 에러 경로/차단 경로가 누락되지 않았는가?
- 관련 테스트/README/운영 문서와 충돌하지 않는가?
